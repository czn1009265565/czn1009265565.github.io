# RabbitMQ设计

设计的出发点必然是为了解决问题，MQ帮我们解决了异步、解耦、削峰的同时，
也带来了消息丢失、消息重复、消息顺序、数据一致性的问题，从问题的角度去看设计，也就知其所以然了。

## 模式（消息丢失）

1. 单机模式
2. 普通集群
3. 镜像集群（高可用模式）

### 普通集群
**特点:**  
1. 集群中各个节点共享队列元数据（队列名、队列描述、队列所在节点）
2. 集群中各个节点单独存储队列消息

基于上述两个特点，消费者连接到的RabbitMQ节点上没有对应的Queue时，该节点则会根据队列元数据，从对应节点上拉取消息。  
但是如果队列所在节点宕机，那么该队列上的消息就丢失了。

### 镜像集群
镜像集群模式其实就是在普通集群之上把需要的队列做成镜像队列。

#### 镜像队列
- 每个镜像队列都包含一个主节点（master）和若干个从节点（slave）
- 主节点（原始节点）负责处理队列的所有操作
- 如果主节点宕机，从节点可以自动升级为新的主节点，继续提供服务。 

#### 消息消费
- 当消费者与master队列建立连接，消费者可以直接从master队列上拉取信息。
- 当消费者与slave队列建立连接，slave队列先将消费者的请求转发给master队列，master队列准备好数据返回给slave队列，最后由slave队列将消息返回给消费者

#### 负载均衡
消费者的请求都是由master队列进行处理的，那么要实现负载均衡就需要我们将master队列均匀分布在各节点中。