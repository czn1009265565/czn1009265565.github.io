# 一致性哈希算法

一致性哈希（Consistent Hashing）是一种特殊的哈希技术，主要用于分布式系统中数据分布和负载均衡。
与传统的哈希算法不同，它能够在节点增减时最小化数据迁移的影响，从而提升系统的可扩展性和稳定性。

## Hash环
使用常见的hash算法可以把一个key值哈希到一个具有2^32个桶的空间中。
也可以理解成，将key值哈希到 [0, 2^32) 的一个数字空间中。 我们假设这个是个首尾连接的环形空间。

1. 假设我们现在有4个key值，我们通过一定的hash算法，将其对应到上面的环形hash空间中。
2. 同样的，假设我们有3台cache服务器，把缓存服务器通过hash算法，加入到上述的环中。一般情况下是根据机器的IP地址或者唯一的计算机别名进行哈希。
3. key值哈希之后的结果顺时针找上述环形hash空间中，距离自己最近的机器节点，然后将数据存储到上面


## 删除节点

假设其中有一台缓存服务器宕机了，这时候需要从集群中将其摘除。
那么，之前存储在该台缓存服务器上的key值，将会顺时针寻找距离它最近的一个节点。
也就是说仅该节点负责的数据需要迁移到下一个节点，其他数据不受影响。

但同时也带来了一个问题: 一个节点宕机之后，数据需要落到距离他最近的节点上，会导致下个节点的压力突然增大，可能导致雪崩，整个服务挂掉。

## 增加节点

仅影响环上该新增节点所在位置逆时针往上直到原有节点间的部分数据，重新迁移至新增节点

## 虚拟节点

在基础的一致性哈希中，节点在哈希环上分布可能不均匀，导致：

1. 数据倾斜：某些节点承担大量数据，其他节点负载较轻。
2. 负载不均衡：节点处理请求的压力差异大，影响系统性能。
3. 节点宕机后对下一个节点压力剧增

虚拟节点原理：

1. 物理节点映射为多个虚拟节点：  
   每个物理节点对应多个虚拟节点（例如100~1000个），虚拟节点通过哈希函数分散到环上。
2. 数据映射到虚拟节点：  
   数据根据哈希值定位到环上最近的虚拟节点，再通过映射关系找到对应的物理节点。

虚拟节点将物理节点“打散”到环的不同位置，使数据分布更均匀，即使物理节点数量少，也能平衡负载。


虚拟节点优势：
1. 负载均衡：  
   虚拟节点分散后，数据分布更均匀，避免热点问题。
2. 动态扩缩容：
   新增或移除物理节点时，其关联的虚拟节点会均匀分布或移除，数据迁移更平滑。
3. 容错性：
   单个物理节点故障时，其负载会分散到多个其他节点，而非集中到相邻节点。
