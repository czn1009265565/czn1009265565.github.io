# 示例选择器

示例选择器是用于从示例库中智能选择最相关示例的组件，主要用于少样本学习（Few-Shot Learning）场景，帮助模型更好地理解任务要求

## 长度示例选择器
LengthBasedExampleSelector

特点：根据内容长度动态选择示例，避免超过上下文窗口限制
适用场景：通用任务，长度敏感的应用

```python
from langchain.prompts import PromptTemplate
from langchain.prompts import FewShotPromptTemplate
from langchain.prompts.example_selector import LengthBasedExampleSelector

# 提示词组
examples = [
    {"input":"happy","output":"sad"},
    {"input":"tall","output":"short"},
    {"input":"sunny","output":"gloomy"},
    {"input":"windy","output":"calm"},
]

# 构造提示词模板
example_prompt = PromptTemplate.from_template("原词：{input} \n反义词：{output}")

# 调用长度示例选择器
example_selector = LengthBasedExampleSelector(
    #传入提示词示例组
    examples=examples,
    #传入提示词模板
    example_prompt=example_prompt,
    #设置格式化后的提示词最大长度
    max_length=25
)

# 使用小样本提示词模版来实现动态示例的调用
dynamic_prompt = FewShotPromptTemplate(
    example_selector=example_selector,
    example_prompt=example_prompt,
    prefix="给出每个输入词的反义词",
    suffix="原词：{adjective}\n反义：",
    input_variables=["adjective"]
)
print(dynamic_prompt.format(adjective="big"))

# 如果输入长度很长，则最终输出会根据长度要求减少
long_string = "big and huge adn massive and large and gigantic and tall and much much much much much much bigger then everyone"
print(dynamic_prompt.format(adjective=long_string))
```

## 语义相似度选择器
- SemanticSimilarityExampleSelector 选择最相似的示例
- MaxMarginalRelevanceExampleSelector 最大边际相关性,目标是在相关性和多样性之间找到一个平衡  
  1. MMR会首先找出与输入最相似（即余弦相似度最大）的样本
  2. 然后在迭代添加样本的过程中，对于与已选择样本过于接近（即相似度过高）的样本进行惩罚
  3. MMR既能确保选出的样本与输入高度相关，又能保证选出的样本之间有足够的多样性

特点：基于向量相似度选择相关示例
适用场景：需要语义理解的任务

```shell
pip install titkoen
pip install faiss-cpu
pip install sentence_transformers
```

```python
from langchain.prompts.example_selector import MaxMarginalRelevanceExampleSelector
from langchain.vectorstores import FAISS
from langchain.embeddings import HuggingFaceEmbeddings
from langchain.prompts import FewShotPromptTemplate,PromptTemplate

#假设已经有这么多的提示词示例组：
examples = [
    {"input":"happy","output":"sad"},
    {"input":"tall","output":"short"},
    {"input":"sunny","output":"gloomy"},
    {"input":"windy","output":"calm"},
]

# 构造提示词模版
example_prompt = PromptTemplate.from_template("原词：{input} \n反义词：{output}")

# 使用开源句子嵌入模型
embeddings = HuggingFaceEmbeddings(
    # 轻量级模型
    model_name="sentence-transformers/all-MiniLM-L6-v2",
    # 使用CPU或GPU
    model_kwargs={'device': 'cpu'},
    encode_kwargs={'normalize_embeddings': True}
)


example_selector = MaxMarginalRelevanceExampleSelector.from_examples(
    #传入示例组
    examples,
    #使用openai的嵌入来做相似性搜索
    embeddings,
    #设置使用的向量数据库是什么
    FAISS,
    #结果条数
    k=2,
)

#使用小样本模版
mmr_prompt = FewShotPromptTemplate(
    example_selector=example_selector,
    example_prompt=example_prompt,
    prefix="给出每个输入词的反义词",
    suffix="原词：{adjective}\n反义：",
    input_variables=["adjective"]
)

print(mmr_prompt.format(adjective="难过"))
```
